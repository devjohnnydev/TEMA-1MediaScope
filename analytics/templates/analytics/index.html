{% extends "analytics/base.html" %}

{% block title %}Dashboard - Media Scope{% endblock %}

{% block content %}

<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); 
        gap: 25px;
    }
    .kpi-card { grid-column: span 1; } 
    .insights-card { 
        grid-column: span 3; 
        grid-row: span 2;
    } 
    .comparison-card { grid-column: span 1; } 
    .table-card { grid-column: span 3; } 
    .cta-card { grid-column: span 1; }
    
    .kpi-card-value { font-size: 2.5rem; font-weight: 700; color: var(--text-color); margin-bottom: 10px; }
    
    /* [MUDANÇA] Lógica de cor para o percentual */
    .kpi-card-trend { display: flex; gap: 10px; align-items: center; font-size: 0.9rem; }
    .kpi-card-trend.positive { color: var(--green); }
    .kpi-card-trend.negative { color: var(--red); }
    .kpi-card-trend .percent { background-color: rgba(0, 196, 159, 0.1); padding: 4px 8px; border-radius: 20px; }
    .kpi-card-trend.negative .percent { background-color: rgba(255, 100, 100, 0.1); }
    
    .insights-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .insights-legend { display: flex; gap: 20px; }
    .insights-legend span { display: flex; align-items: center; gap: 8px; }
    .insights-legend .dot1 { width: 10px; height: 10px; background-color: var(--primary); border-radius: 50%; }
    .insights-legend .dot2 { width: 10px; height: 10px; background-color: #BA3780; border-radius: 50%; }
    .region-chart-container {
        height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* [MUDANÇA] CSS para o card de Comparação */
    .comp-item { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .comp-item:last-child { margin-bottom: 0; }
    .comp-icon { font-size: 2rem; color: var(--primary); background-color: var(--bg-color); padding: 12px; border-radius: 10px; }
    .comp-text { flex-grow: 1; }
    .comp-text span { font-size: 0.9rem; color: var(--text-muted); }
    .comp-text h4 { font-size: 1.2rem; color: var(--text-color); margin: 2px 0; }
    .comp-trend { font-size: 0.9rem; font-weight: 600; }
    .comp-trend.positive { color: var(--green); }
    .comp-trend.negative { color: var(--red); }

    .video-table { width: 100%; border-collapse: collapse; }
    .video-table th, .video-table td { padding: 15px 10px; text-align: left; border-bottom: 1px solid var(--bg-color); }
    .video-table th { color: var(--text-muted); font-size: 0.9rem; }
    .video-table td { font-weight: 500; }
    .video-title { display: flex; align-items: center; gap: 15px; }
    .video-title img { width: 50px; height: 30px; border-radius: 4px; object-fit: cover; }
    .video-table .status-active { color: var(--green); }
    .cta-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; flex-direction: column; justify-content: center; }
    .cta-card h3 { font-size: 1.3rem; margin-bottom: 10px; }
    .cta-card p { color: var(--text-color); margin-bottom: 20px; }
    .cta-card a { text-decoration: none; color: #333; background-color: #fff; padding: 10px 20px; border-radius: 6px; font-weight: 600; align-self: flex-start; }
    .error-card { background-color: #353542; padding: 20px; border-radius: 12px; color: #ff8a80; grid-column: 1 / -1; }
</style>

{% if error_message %}
    <div class="card error-card">
        <h3>Erro ao carregar dados</h3>
        <p>{{ error_message }}</p>
    </div>
{% endif %}

<div class="dashboard-grid">

    <div class="card kpi-card">
        <div class="card-title">Top 5 Regiões (Views)</div>
        <div class="region-chart-container">
            <canvas id="regionChart"></canvas>
        </div>
    </div>

    <div class="card kpi-card">
        <div class="card-title">Likes (Últimos 28 dias)</div>
        <div class="kpi-card-value">{{ kpi_cards.likes|default:"0" }}</div>
        {% with change=kpi_cards.likes_change|default:0 %}
            <div class="kpi-card-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                <span class="percent">{{ change }}%</span>
                <span>vs. período anterior</span>
            </div>
        {% endwith %}
    </div>

    <div class="card kpi-card">
        <div class="card-title">Visualizações (Últimos 28 dias)</div>
        <div class="kpi-card-value">{{ kpi_cards.views|default:"0" }}</div>
        {% with change=kpi_cards.views_change|default:0 %}
            <div class="kpi-card-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                <span class="percent">{{ change }}%</span>
                <span>vs. período anterior</span>
            </div>
        {% endwith %}
    </div>

    <div class="card kpi-card">
        <div class="card-title">Inscritos (Líquido, 28 dias)</div>
        <div class="kpi-card-value">{{ kpi_cards.subscribers|default:"0" }}</div>
        {% with change=kpi_cards.subscribers_change|default:0 %}
            <div class="kpi-card-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                <span class="percent">{{ change }}%</span>
                <span>vs. período anterior</span>
            </div>
        {% endwith %}
    </div>

    <div class="card insights-card">
        <div class="insights-header">
            <div class="insights-legend">
                <span class="card-title">Insights (Últimos 28 dias)</span>
                <span><span class="dot1"></span> Visualizações</span>
                <span><span class="dot2"></span> Likes</span>
            </div>
        </div>
        <div style="height: 350px;">
            <canvas id="insightsChart"></canvas>
        </div>
    </div>

   <div class="card comparison-card">
        <div class="card-title">Comparação (vs. período anterior)</div>
        
        <div class="comp-item">
            <span class="material-symbols-outlined comp-icon">visibility</span>
            <div class="comp-text">
                <span>Visualizações</span>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <h4>{{ comparison_card.views|floatformat:"0" }}</h4>
                    {% with change=comparison_card.views_change|default:0 %}
                        <span class="comp-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                            {{ change }}%
                        </span>
                    {% endwith %}
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted); margin-top: -5px; display: block;">
                    Anterior: {{ comparison_card.views_prev|floatformat:"0" }}
                </span>
            </div>
        </div>
        
        <div class="comp-item">
            <span class="material-symbols-outlined comp-icon">thumb_up</span>
            <div class="comp-text">
                <span>Likes</span>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <h4>{{ comparison_card.likes|floatformat:"0" }}</h4>
                    {% with change=comparison_card.likes_change|default:0 %}
                        <span class="comp-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                            {{ change }}%
                        </span>
                    {% endwith %}
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted); margin-top: -5px; display: block;">
                    Anterior: {{ comparison_card.likes_prev|floatformat:"0" }}
                </span>
            </div>
        </div>
        
        <div class="comp-item">
            <span class="material-symbols-outlined comp-icon">comment</span>
            <div class="comp-text">
                <span>Comentários</span>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <h4>{{ comparison_card.comments|floatformat:"0" }}</h4>
                    {% with change=comparison_card.comments_change|default:0 %}
                        <span class="comp-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                            {{ change }}%
                        </span>
                    {% endwith %}
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted); margin-top: -5px; display: block;">
                    Anterior: {{ comparison_card.comments_prev|floatformat:"0" }}
                </span>
            </div>
        </div>
        
        <div class="comp-item">
            <span class="material-symbols-outlined comp-icon">share</span>
            <div class="comp-text">
                <span>Compartilhamentos</span>
                <div style="display: flex; align-items: baseline; gap: 10px;">
                    <h4>{{ comparison_card.shares|floatformat:"0" }}</h4>
                    {% with change=comparison_card.shares_change|default:0 %}
                        <span class="comp-trend {% if change > 0 %}positive{% else %}negative{% endif %}">
                            {{ change }}%
                        </span>
                    {% endwith %}
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted); margin-top: -5px; display: block;">
                    Anterior: {{ comparison_card.shares_prev|floatformat:"0" }}
                </span>
            </div>
        </div>
    </div>



    <div class="card table-card">
        <div class="card-title">Engajamento por vídeo (5 mais recentes)</div>
        <table class="video-table">
            <thead>
                <tr>
                    <th>Vídeo</th>
                    <th>Status</th>
                    <th>Likes</th>
                    <th>Comentários</th>
                </tr>
            </thead>
            <tbody>
                {% for video in video_table_data %}
                <tr>
                    <td>
                        <div class="video-title">
                            <img src="{{ video.thumbnail }}" alt="thumbnail">
                            <span>{{ video.title|truncatechars:40 }}</span>
                        </div>
                    </td>
                    <td><span class="status-active">{{ video.status }}</span></td>
                    <td>{{ video.likes|floatformat:"0" }}</td>
                    <td>{{ video.comments|floatformat:"0" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">Nenhum vídeo encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="card cta-card">
        <h3>De um Boost na sua conta</h3>
        <p>O Plano que Você Usa para Dominar o Mercado</p>
        <a href="{% url 'planos' %}">Saiba Mais</a>
    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>


<script>
// --- [A "PONTE NUCLEAR"] ---
// 1. Injeta o JSON da view (ou 'null') direto em uma var JS
//    O |safe é necessário para o Django renderizar o JSON como código, não como texto
const chartData = {{ insights_chart_data|default:"null"|safe }};
const regionData = {{ region_chart_data|default:"null"|safe }};

// --- Gráfico de Insights (Barras) ---
// 2. Checa se a VARIÁVEL (não o elemento) existe
if (chartData && chartData.datasets) { 
    new Chart( document.getElementById('insightsChart'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: chartData.datasets.map(dataset => ({
                ...dataset,
                borderRadius: 6
            }))
        },
        options: { // (As opções são as mesmas de antes)
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, min: 0, grid: { color: '#444' }, ticks: { color: '#A0A0A0' } },
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM dd' } },
                    grid: { display: false },
                    ticks: { color: '#A0A0A0' }
                }
            }
        }
    });
}

// --- Gráfico de Região (Donut) ---
// 2. Checa se a VARIÁVEL (não o elemento) existe
if (regionData && regionData.datasets) {
    new Chart( document.getElementById('regionChart'), {
        type: 'doughnut',
        data: regionData,
        options: { // (As opções são as mesmas de antes)
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}
</script>

{% endblock %}